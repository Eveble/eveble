test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
    env:
      USERNAME: ${{ github.event.github.actor }}
      MONGO_URI: mongodb://root:password@localhost:27017/?replicaSet=rs0&authSource=admin
    name: ‚úÖ Test
    steps:
      - uses: actions/checkout@v3

      - name: üê≥ Start MongoDB Replica Set
        run: |
          docker run -d \
            --name mongodb-rs \
            -p 27017:27017 \
            -e MONGO_INITDB_ROOT_USERNAME=root \
            -e MONGO_INITDB_ROOT_PASSWORD=password \
            mongo:7.0 \
            --replSet rs0 --bind_ip_all

          # Wait for MongoDB to be ready
          sleep 5

          # Initialize replica set
          docker exec mongodb-rs mongosh --eval "
            rs.initiate({
              _id: 'rs0',
              members: [{ _id: 0, host: 'localhost:27017' }]
            })
          "

          # Wait for replica set to be ready
          sleep 5

      - name: ‚öôÔ∏è Setup Node@${{ matrix.node-version}}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          registry-url: 'https://npm.pkg.github.com/'
          scope: ${{ env.USERNAME }}

      - name: üöß Install dependencies
        run: yarn install
        env:
          NODE_AUTH_TOKEN: ${{ secrets.EVEBLE_TYPES_AUTH_TOKEN }}

      - run: yarn test

      - name: [failed] üè∑Ô∏è Remove test label
        uses: actions/github-script@v6
        if: failure() && contains(env.isFork, 'false')
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            if ('${{ contains(github.event.pull_request.labels.*.name, 'tested') }}' == 'true') {
              github.issues.removeLabel({owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number,
                name: 'tested'
              })
            }

      - name: [success] üè∑Ô∏è Add test label
        uses: actions/github-script@v6
        if: contains(env.isFork, 'false')
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.issues.addLabels({owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number,
              labels: ['tested']
            })
